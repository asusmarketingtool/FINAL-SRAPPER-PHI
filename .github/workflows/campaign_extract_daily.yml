name: Daily Extracts (Campaign + Ads Dialog) Chile 10:00

on:
  schedule:
    # 09:00 en Chile (UTC-3) ‚Üí 12:00 UTC
    - cron: "0 12 * * *"
  workflow_dispatch: {}    # manual: siempre corre

jobs:
  daily-extracts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright gspread google-auth
          python -m playwright install --with-deps chromium

      # 1Ô∏è‚É£ Campaign Extract
      - name: Run Campaign Extract
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
        run: |
          echo "üöÄ Iniciando Campaign Extract..."
          python campaign_extract_to_sheets.py
          echo "‚úÖ Campaign Extract finalizado."

      # 2Ô∏è‚É£ Ads Dialog Extract (actualiza EXTRACT_LIM)
      - name: Run Ads Dialog Extract
        env:
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
        run: |
          echo "üöÄ Iniciando Ads Dialog Extract..."
          python test_ads_dialog_extract_v5.py
          echo "‚úÖ Ads Dialog Extract finalizado."

      # 3Ô∏è‚É£ Notificaci√≥n por correo (siempre se ejecuta, aunque falle algo arriba)
      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}

          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}

          # Remitente fijo para evitar el error "from vac√≠o"
          from: "josepedro_montes@asus.com"

          # Destinatario(s)
          to: "josepedro_montes@asus.com"

          # Asunto del correo
          subject: >
            [Daily Extracts] Estado del job: ${{ job.status }}

          # Cuerpo del correo (texto plano)
          body: |
            Hola Chepe,

            El workflow "Daily Extracts (Campaign + Ads Dialog) Chile 10:00" acaba de terminar.

            Estado del job: ${{ job.status }}

            Detalles:
            - Repositorio: ${{ github.repository }}
            - Branch: ${{ github.ref_name }}
            - Run ID: ${{ github.run_id }}
            - Disparado por: ${{ github.event_name }}

            Link directo al run:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            (Este correo se env√≠a autom√°ticamente desde GitHub Actions.)

